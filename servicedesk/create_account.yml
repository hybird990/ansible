- name: Create AD User with Groups
  hosts: localhost
  gather_facts: no
  vars:
    username: "{{ username }}"
    groups: ["Domain Users", "IT Department"]
  tasks:
    - name: Create AD user and add to groups
      win_shell: |
        $pass = ConvertTo-SecureString -AsPlainText "Welcome123!" -Force
        New-ADUser -Name "{{ username }}" -SamAccountName "{{ username }}" -AccountPassword $pass -Enabled $true -Path "CN=Users,DC=yourdomain,DC=local"
        foreach ($group in @({{ groups | join(',') }})) {
          Add-ADGroupMember -Identity $group -Members "{{ username }}"
        }
