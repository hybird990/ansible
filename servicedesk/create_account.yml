- name: Create a new user account
  hosts: 192.168.1.11
  gather_facts: no

  tasks:
    - name: ğŸ’¬ Display received username
      debug:
        msg: "Received user = {{ user }}"

    - name: Create user account via PowerShell
      win_shell: |
        $username = "{{ user }}"
        $password = "InitialPassword123!"

        try {
          Write-Output "ğŸ› ï¸ Creating user '$username'..."

          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
            Write-Output "âš ï¸ User '$username' already exists."
          } else {
            New-LocalUser -Name $username `
              -Password (ConvertTo-SecureString $password -AsPlainText -Force) `
              -FullName $username `
              -AccountNeverExpires:$true
            Add-LocalGroupMember -Group "Users" -Member $username
            Write-Output "âœ… New account '$username' has been created."
          }

        } catch {
          Write-Output "âŒ Failed to create account '$username': $($_.Exception.Message)"
        }
      register: result

    - name: Show result
      debug:
        var: result.stdout_lines
