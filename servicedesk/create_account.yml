- name: Create a new user account
  hosts: 192.168.1.11
  gather_facts: no

  vars:
    # Optional default for testing; remove in production
    user: "{{ user | default('placeholderUser') }}"
    password: "{{ password | default('InitialPassword123!') }}"

  tasks:
    - name: üí¨ Display received username
      debug:
        msg: "Received user = {{ user }} and password = {{ password }}"

    - name: Create user account via PowerShell
      win_shell: |
        $username = "{{ user }}"
        $password = "{{ password }}"

        try {
          Write-Output "üõ†Ô∏è Creating user '$username'..."

          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
            Write-Output "‚ö†Ô∏è User '$username' already exists."
          } else {
            New-LocalUser -Name $username `
              -Password (ConvertTo-SecureString $password -AsPlainText -Force) `
              -FullName $username `
              -AccountNeverExpires:$true
            Add-LocalGroupMember -Group "Users" -Member $username
            Write-Output "‚úÖ New account '$username' has been created."
          }

        } catch {
          Write-Output "‚ùå Failed to create account '$username': $($_.Exception.Message)"
        }
      register: result

    - name: Show result
      debug:
        var: result.stdout_lines
